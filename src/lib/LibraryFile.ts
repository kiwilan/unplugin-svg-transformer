import type { SvgItem } from './Svg/SvgItem'
import { Utils } from './Utils'

export class LibraryFile {
  protected constructor(
    protected items: SvgItem[] = [],
    protected list?: string,
    protected types?: string,
  ) { }

  public static async make(items: SvgItem[]): Promise<LibraryFile> {
    const self = new LibraryFile(items)

    self.list = await self.setList()
    self.types = await self.setTypes()

    return self
  }

  public getList(): string {
    return this.list!
  }

  public getTypes(): string {
    return this.types!
  }

  public content(): string {
    const content = [
      '/* eslint-disable */',
      '/* prettier-ignore */',
      '// @ts-nocheck',
      '// Generated by unplugin-svg-transformer',
      this.list!,
    ]

    return content.join('\n')
  }

  public async update(path: string, window = true, typescript = true): Promise<string> {
    this.list = await this.setList(path, window, typescript)
    if (!typescript)
      this.types = ''

    return this.list
  }

  private async setTypes(): Promise<string> {
    let content = ''
    content += 'export type IconType = '
    this.items.forEach((item, key) => {
      if (key > 0)
        content += ' | '

      content += `'${item.getName()}'`
    })

    if (this.items.length > 0)
      content += ' | \'default\''
    else
      content += '\'default\''

    content += '\n'

    return content
  }

  private async setList(basePath = '', window = true, typescript = true): Promise<string> {
    const content = []

    if (typescript)
      content.push('export const IconList: Record<IconType | string, Promise<{ default: string }>> = {\n')
    else
      content.push('export const IconList = {\n')

    this.items.forEach((item) => {
      const localPath = item.getPath()
      let path = Utils.normalizePaths([basePath, localPath])
      path = path.replace('.svg', '')

      content.push(`  '${item.getName()}': '${path}',\n`)
    })

    content.push('}\n')

    content.push('\n')
    content.push('export function importIcon(name: IconType | string): Promise<string> {\n')
    // eslint-disable-next-line no-template-curly-in-string
    content.push('  return import(/* @vite-ignore */ `${IconList[name] || IconList["default"]}.ts`)\n')
    content.push('}\n')

    if (window) {
      content.push('\n')
      content.push('if (typeof window !== \'undefined\') {\n')
      // content.push('  // @ts-expect-error type is global\n')
      content.push('  window.iconList = IconList\n')
      content.push('  window.importIcon = importIcon\n')
      content.push('}\n')
    }

    return content.join('')
  }
}
